v1. Логика SL/TP и условия сигнала
0) Базовые метрики (на входе движка)

TF входа: 15m.

Контекст: H1 (вторичный), H4 (главный для зон/направления).

ATR: ATR(15m) и ATR(H4). Все пороги ниже — в ATR, чтобы не «ломалось» на разных монетах.

Зоны: ближайшие S/R на 15m, H1, H4.

Свободный ход (FH): расстояние от точки входа до ближайшей противоположной зоны на 15m, в R и ATR.

HTF-запрет около сильной зоны:

НЕ шортить, если цена внутри H4-поддержки или ≤ 0.20·ATR(H4) над её верхней границей.

НЕ лонговать, если цена внутри H4-сопротивления или ≥ 0.20·ATR(H4) под её нижней границей.

Вход

Вариант A (как сейчас): по Close сигнальной 15m-свечи (рынок).

Stop-Loss (SL)

Базовый принцип: ставим там, где структурно сломается идея.

Разворот от HTF-зоны:
SL за границу зоны HTF + буфер = max(0.25, 0.35)·ATR(15m) в зависимости от «шумности» инструмента.
Если экстремум паттерна дальше границы — SL за экстремум + тот же буфер.

Продолжение тренда (не HTF-разворот):
SL за локальный свинг (на 15m) + 0.25·ATR(15m).

Жёсткие стопы избегаем: фикс 1.5% иногда слишком близко/далеко; ATR-буфер даёт стабильность по всем монетам.

Fail-safe: если после входа в первые 3 свечи 15m цена не даёт ≥0.3R и рисует противо-энгальф на 1m/5m размером > 1.2·ATR(1m) — допускается досрочный выход (снижение хвоста убытка).

Take-Profit (многоступенчато)

TP1 (ранний фикc/контроль):

Ближайшая противоположная 15m-зона или 1R — что раньше.

Зафиксировать 40–60% позиции.

Перевод в BE: сразу после TP1 или по закрытию свечи за 0.8R (если до зоны близко и TP1 маленький).

TP2 (основной):

Ближайшая H1-зона или 2R — что раньше.

Если TP2 и SL срабатывают «одновременно» в реальном тике — сохраняем ваш приоритет TP2 над SL (как и было).

TP3 (опционально, сильный тренд):

H4-зона или 3R (редко, но позволит брать хвосты импульсов).

Трейлинг после TP1 (опционально, если не закрыли всё):

Структурный: под/над последним swing-HL/ LH на 1m/5m с буфером 0.20–0.30·ATR(1m).

ATR-шаговый: SL_trail = High/Low_n − 1.0·ATR(1m) обновлять на каждом новом swing.
Доп. условия/запреты, которые реально сокращают ошибки

Запрет контринтуитивных входов у зоны:

возле поддержки не шортим; возле сопротивления не лонгуем (как обсуждали). Порог — см. п.1 (0.20·ATR(H4) от границы).

Размер сигнальной свечи: если она >1.2·ATR(15m) — чаще это вынос; вход разрешать только по B-варианту (лимит на ретест), либо скип.

Широкая зона 15m (очень жирная ликвидность): если ширина зоны > 1.2R, вход по ней скип либо с лимитом внутри зоны (иначе SL часто «в зоне» и ловит пилу).

Мид-райанж: если паттерн в середине коридора между ближайшими 15m-зонами (±20%) — скип (нет явного краевого преимущества).