Ключевые метрики (на 15m)

ATR15 — для нормализации размеров.

TR_norm = TrueRange / ATR15 (размер бара в ×ATR).

Body_norm = |Close-Open| / ATR15 (тело в ×ATR).

Overlap% — доля перекрытия текущего бара телом/диапазоном предыдущего.

DonchianWidth_M — ширина диапазона за M баров: max(H) - min(L).

DW_ratio = DonchianWidth_M(now) / DonchianWidth_M(M баров назад) (сжатие/расширение).

DirScore (для направленности):
DirScore = |Σ(sign(Return_i))| / N за окно N баров. (0→ хаос, 1→ все в одну сторону.)

Рекомендуемые окна: N=5, M=8 (рабочий баланс для 15m).

Классификация Arrival (V1)
1) impulse (вверх/вниз)

Идея: несколько крупных баров, направленных, с расширением диапазона.

Размер: ≥ 3 из последних 5 баров имеют TR_norm ≥ 0.60.

Направление: DirScore ≥ 0.60 и минимум 3 бара из 5 закрылись в сторону движения.

Расширение: DW_ratio ≥ 1.15 (за последние M=8 баров диапазон вырос ≥15%).

Фильтр «не пинбар»: у «ядра импульса» Body_norm ≥ 0.35 минимум в 2 барах (чтобы не было чистого хвоста).

Выход:

если high/close растут ⇒ impulse_up;

если low/close падают ⇒ impulse_down.

Пояснение: твоё >0.6×ATR вполне ок; добавили требование расширения и направленности, чтобы не путать с «гриндом».

2) compression (сужение, «поджатие» к зоне)

Идея: барам тесно, амплитуда и тела малы, диапазон сужается.

Размер: ≥ 5 из 6 последних баров имеют TR_norm ≤ 0.40 и Body_norm ≤ 0.25.

Сужение диапазона: DW_ratio ≤ 0.70 за M=8 баров (сужение ≥30%).

Перекрытие: в ≥ 4 из 6 баров Overlap% ≥ 50%.

Косой «гринд» (узнаём как подтип compression): та же малость баров, но DirScore ≥ 0.50 и серия HH без прогресса тела ⇒ grind_up/down (оставим как подметку; для основного поля — всё равно compression).

Пояснение: добавили триггеры на ширину диапазона и перекрытие — это ключ к «поджиму».

3) chop (пила/хаос)

Идея: нет явного трендового импульса, нет сужения — разнонаправленный шум.

Не выполнены условия impulse и compression.

Доп. признак (подтвердить хаос): за N=5 баров минимум 3 смены знака закрытия (up/down), Overlap% ≥ 40% как минимум в половине баров.

Выход: chop.

Направление относительно зоны (важно для фильтров)

Для поддержки/сопротивления определяем arrival_dir:

Если сопротивление сверху и последние N баров преимущественно растут ⇒ arrival_dir = up_to_res.

Если поддержка снизу и последние N баров падают ⇒ arrival_dir = down_to_sup.
Используем в правилах «не лонговать под сопротивлением / не шортить над поддержкой» с усилением, если arrival = impulse или grind в сторону зоны.

Дебаунс/стабильность метки

Чтобы метки не “мигали”:

Stickiness: присвоенная метка держится минимум 2 бара, если новые данные не дают сильного противоположного сигнала (например, impulse сменится только на compression, если DW_ratio упал ≤0.85 и 4/6 баров стали малыми).

Outlier guard: один бар с TR_norm ≥ 1.20 без направленности не меняет compression на impulse — считаем «хвост/вынос», если нет подтверждения по DirScore и DW_ratio.

Пороговые значения (V1, можно тюнить)

TR_norm big: 0.60

TR_norm small: 0.40

Body_norm min для ядра импульса: 0.35

DW_ratio expand (impulse): ≥ 1.15 за M=8

DW_ratio compress (compression): ≤ 0.70 за M=8

Overlap% граница: 50%

DirScore порог: 0.60 (impulse), 0.50 для grind-подметки

Окна: N=5, M=8 (для 15m оптимально по опыту; потом подстроим по твоей статистике)

Как использовать в фильтрах (прямые правила)

compression / grind → в зону: повышенный риск пробоя зоны →
• отбой против направления запрещён без подтверждения (sweep→reclaim/BOS+retest),
• SL — htf_anchor или retest_swing, не «за край 15m».

impulse → в зону: отбой против импульса возможен только при явном «съёме ликвидности» и возврате; иначе — ждать breakout→pullback и торговать по импульсу.

chop: входы допустимы, но требуем free_path_R ≥ 1.2 и зону не «уставшую».

Маленькие доп. флажки (необязательно, но полезно)

flush_up / flush_down: 1–2 бара с TR_norm ≥ 1.20 и Body_norm ≥ 0.50 → «смыв»/вынос. Используем, чтобы не путать с обычным impulse и усиливать требования к подтверждению для контр-входа.

sweep_flag: текущий бар вынес High(N)/Low(N) (N=8) на ≥ 0.30×ATR15 и закрылся обратно в диапазон → сильный кандидат для sweep→reclaim.