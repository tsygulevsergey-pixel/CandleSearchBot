Блок A — S/R-фильтры (MTF) для разрешения/запрета направления

Обозначения:
ATR15 = ATR(14) на 15m, ATR1h = ATR(14) на 1h.
dist(x→zoneEdge) — расстояние в цене от x до ближайшей границы зоны (верх/низ) в нужном направлении.
“внутри зоны” = цена ∈ [lowEdge, highEdge] с допуском 0.1·ATR15.

1) Жёсткие вето от старших ТФ

Вето H4: если для ЛОНГА ближайшая H4-сопрот сверху на расстоянии < 0.7·ATR1h → лонг запрещён. Для ШОРТА симметрично: ближайшая H4-поддержка снизу < 0.7·ATR1h → шорт запрещён.

Вето H1 (когда H4 далеко): если для ЛОНГА H1-сопротивление сверху < 1.0·ATR15 → лонг запрещён. Для ШОРТА — H1-поддержка снизу < 1.0·ATR15 → шорт запрещён.

Смысл: не шортить «в упор» к поддержке старшего ТФ и не лонговать «в упор» к сопротивлению старшего ТФ. Это и было источником большинства стопов в кейсах.

2) Где допускаем направление по 15m

ЛОНГ: цена внутри 15m-поддержки или не выше её верхней границы больше чем на +0.2·ATR15; при этом до ближайшего 15m-сопротивления сверху должно быть ≥ 1.0·R (см. ниже, как считать R).

ШОРТ: цена внутри 15m-сопротивления или не ниже его нижней границы больше чем на −0.2·ATR15; при этом до ближайшей 15m-поддержки снизу ≥ 1.0·R.

3) Конфликты между ТФ — правило старшинства

Если 15m говорит «лонг у поддержки», но на 1h/4h прямо над головой плотные сопротивления (см. вето выше) — сигнал пропустить (не «переворачивать», именно пропустить).

Если 15m «шорт у сопротивления», но на 1h/4h прямо под ценой поддержка — пропустить.

4) Свежесть/прочность зоны

Если зона 15m уже тестировалась ≥2 раз за последние 24ч, увеличиваем минимальную дистанцию-разрешение на +0.2·ATR15 (зона «разбита»).

Если зона 1h/4h свежая (первый ретест) — к порогам вето добавляем +0.2·ATR15/+0.1·ATR1h (делаем вето ещё строже).

Блок B — как считать риск (R), SL и TP динамически
5) Базовый риск (R) и стоп

Определяем уровень инвалидации откуда идея ломается:

ЛОНГ от поддержки:
SL_base = нижняя граница активной 15m-поддержки − buf, где
buf = clamp(0.15, 0.35) · ATR15,
и берём верхнюю границу 0.35·ATR15, если:

зона тестировалась ≥2 раз, или

в последние 6 баров были длинные хвосты вниз (минимум < нижняя граница − 0.2·ATR15).

ШОРТ от сопротивления:
SL_base = верхняя граница 15m-сопротивления + buf (симметрично).

Ограничители:

min SL = 0.4·ATR15 (избегаем микро-стопов),

max SL = min(высота зоны + 0.3·ATR15, 1.2·ATR15).

R (риск-пункт) = |Entry − SL_base|.

6) Проверка «есть ли место для хода»

Перед подтверждением сигнала считаем до ближайшей противоположной зоны по 15m и 1h:

clearance_15m = dist(Entry → oppZoneEdge_15m)

clearance_1h = dist(Entry → oppZoneEdge_1h)

Берём целевой клиренс clearance = min(clearance_15m, clearance_1h).
Если clearance < 1.0·R → сигнал отменить (нет места даже на 1R).

7) Тейки по «доступному R» (без фиксированной цифры)

Считаем доступный R: R_available = floor( (0.9 · clearance) / R , 0.1 )
(0.9 — буфер не добивать зону до тик-в-тик; округляем вниз по 0.1R).

Если R_available < 1.0 → пропустить.

Если 1.0 ≤ R_available < 2.0 → TP = 1.0R (скальп).

Если 2.0 ≤ R_available < 3.0 → TP = 2.0R.

Если R_available ≥ 3.0 и над/под нами нет H4-зоны ближе чем 3.0R → TP = 3.0R.
Иначе TP = min(3.0R, 0.9·clearance).

Частичные фиксации (рекомендовано):

TP1 = 1.0R (фикс 30–50%), стоп в BE − 0.1·ATR15 (не в ноль, а микропрофит).

TP2 = min(2.0R, край ближайшей 1h-зоны) (фикс 30–50%).

Остаток — трейл по зоновому «флипу» (см. п.8).

8) Трейлинг по флипу зоны

Для лонга: как только 15m-сопротивление, которое мы пробили, ретестится и держится (2 последовательных закрытия выше), переводим стоп под этот «флип-уровень» − 0.15·ATR15.

Для шорта — симметрично.

9) Плохие контексты — автопропуск

Компрессия: диапазон цены за последние 12 баров < 0.7·ATR15 и цена в «серой зоне» (между 15m-S и 15m-R) → пропуск.

Пила между зонами: если расстояние до S и до R обе стороны < 1.0·R → пропуск.

Много перекрывающихся микрозон над/под ценой: если суммарная ширина 2 ближайших зон с нашей стороны хода > 1.5·ATR15 → пропуск (зона «засорена»).

Блок C — в код (как последовательность проверок)

Снять снапшот зон 15m/1h/4h на баре сигнала.

Применить вето H4 → вето H1.

Проверить «в зоне/у зоны» на 15m в сторону сигнала (п.2).

Посчитать SL_base и R (п.5).

Посчитать clearance до противоположных зон 15m и 1h (п.6).

Отфильтровать плохие контексты (п.9).

Выставить TP по R_available (п.7), частичные, и включить трейл-флип (п.8).

Логировать: использованные зоны (id/ТФ/границы), ATR15, ATR1h, SL, R, clearance_15m/1h, R_available, причина пропуска/подтверждения.